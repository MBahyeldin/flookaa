user www-data;
worker_processes auto;

events {
    worker_connections 65000;
}

http {
    ## Core includes
    include "{{ nginx_path }}/conf/mime.types";
    default_type application/octet-stream;

    # Trust X-Forwarded-For headers from localhost
    set_real_ip_from 127.0.0.1;
    set_real_ip_from ::1;

    ## Logging
    log_format json_analytics escape=json '{'
        '"msec":"$msec",'
        '"connection":"$connection",'
        '"connection_requests":"$connection_requests",'
        '"pid":"$pid",'
        '"request_id":"$request_id",'
        '"request_length":"$request_length",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"remote_port":"$remote_port",'
        '"time_local":"$time_local",'
        '"time_iso8601":"$time_iso8601",'
        '"request":"$request",'
        '"request_uri":"$request_uri",'
        '"args":"$args",'
        '"status":"$status",'
        '"body_bytes_sent":"$body_bytes_sent",'
        '"bytes_sent":"$bytes_sent",'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"http_x_forwarded_for":"$http_x_forwarded_for",'
        '"http_host":"$http_host",'
        '"server_name":"$server_name",'
        '"request_time":"$request_time",'
        '"upstream":"$upstream_addr",'
        '"upstream_connect_time":"$upstream_connect_time",'
        '"upstream_header_time":"$upstream_header_time",'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_response_length":"$upstream_response_length",'
        '"upstream_cache_status":"$upstream_cache_status",'
        '"ssl_protocol":"$ssl_protocol",'
        '"ssl_cipher":"$ssl_cipher",'
        '"scheme":"$scheme",'
        '"request_method":"$request_method",'
        '"server_protocol":"$server_protocol",'
        '"pipe":"$pipe",'
        '"gzip_ratio":"$gzip_ratio",'
        '"http_cf_ray":"$http_cf_ray",'
        '"geoip_country_code":"$geoip2_country_code",'
        '"geoip_city_name":"$geoip2_city_name"'
    '}';

    access_log "{{ logging_dir }}/access.log" json_analytics;
    error_log  "{{ logging_dir }}/error.log" warn;

    ## Gzip
    gzip on;
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        application/x-javascript
        application/xml
        application/xml+rss
        image/svg+xml;
    gzip_proxied any;
    gzip_min_length 1000;

    ## Cache-Control map
    map $sent_http_content_type $cache_control {
        default                             "no-cache";
        "text/css"                          "public, max-age=31536000, immutable";
        "application/javascript"            "public, max-age=31536000, immutable";
        "font/woff2"                        "public, max-age=31536000, immutable";
        "~*image/"                          "public, max-age=300";
        "application/json"                  "no-store";
        "~*text/html"                       "no-store, must-revalidate";
    }

    ## WebSocket / HMR support
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    ## GeoIP
    geoip2 "{{ nginx_path }}/GeoIP/GeoLite2-Country.mmdb" {
        $geoip2_country_code source=$remote_addr country iso_code;
    }

    geoip2 "{{ nginx_path }}/GeoIP/GeoLite2-City.mmdb" {
        $geoip2_city_name source=$remote_addr city names en;
    }

    ## Virtual hosts
    include "{{ nginx_path }}/sites-enabled/*.conf";
}
